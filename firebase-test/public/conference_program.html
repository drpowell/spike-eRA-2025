<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Conference Program — Pretty View with Streams</title>
        <style>
            :root {
                --gap: 10px;
                --accent: #0b66c3;
                --muted: #666;
            }
            body {
                font-family: system-ui, -apple-system, Segoe UI, Roboto,
                    Helvetica, Arial;
                color: #111;
                margin: 20px;
                background: #f7f9fc;
            }
            h1 {
                margin: 0 0 10px;
                font-size: 20px;
            }
            .day {
                margin: 18px 0;
                padding: 12px;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
            }
            .day-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 12px;
            }
            .day-header .date {
                font-weight: 600;
            }
            .streams-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
            }
            .streams-table thead th {
                position: sticky;
                top: 0;
                background: linear-gradient(180deg, #fff, #fbfdff);
                z-index: 2;
                border-bottom: 1px solid #eee;
                padding: 8px;
                font-weight: 700;
                text-align: left;
            }
            .streams-table td {
                vertical-align: top;
                padding: 8px;
                border-bottom: 1px dashed #eee;
                background: white;
            }
            .time-col {
                width: 12%;
                white-space: nowrap;
                padding-right: 12px;
                font-weight: 600;
                color: var(--muted);
            }
            .session {
                margin-bottom: 8px;
                padding: 8px;
                border-radius: 6px;
                background: linear-gradient(180deg, #fff, #fcffff);
                border: 1px solid #e6f0fb;
            }
            .session .title {
                font-weight: 700;
                color: var(--accent);
                margin-bottom: 4px;
            }
            .session .meta {
                font-size: 12px;
                color: var(--muted);
            }
            .session a {
                color: inherit;
                text-decoration: none;
            }
            .empty {
                color: #bbb;
                font-size: 13px;
                padding: 6px;
            }
            .legend {
                font-size: 13px;
                color: var(--muted);
                margin-top: 8px;
            }
            @media (max-width: 900px) {
                .streams-table thead th:not(:first-child) {
                    display: none;
                }
                .streams-table td:not(:first-child) {
                    display: none;
                }
            }
        </style>
    </head>
    <body>
        <h1>Conference program — concurrent streams</h1>
        <div id="root">Loading…</div>

        <script>
            (async function () {
                const url = "./conference_program.json";
                let data;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(res.statusText);
                    data = await res.json();
                } catch (e) {
                    document.getElementById("root").innerHTML =
                        '<p style="color:#900">Failed to load conference_program.json — run a local web server and place the file in the same directory. (' +
                        e.message +
                        ")</p>";
                    return;
                }

                // normalize location string for sorting/display
                const normalizeLoc = (s) =>
                    (s || "General").trim() === "N/A" ? "General" : s.trim();

                // group by day -> time
                const byDay = {};
                for (const item of data) {
                    const day = item.day || "Unknown";
                    const time = (item.time || "").trim() || "TBA";
                    const loc = normalizeLoc(item.location);
                    if (!byDay[day]) byDay[day] = [];
                    byDay[day].push(
                        Object.assign({}, item, { time, location: loc })
                    );
                }

                // helper to extract sort key (minutes from midnight) from time string
                function parseStartMinutes(timeStr) {
                    // find first HH:MM in string
                    const m = timeStr.match(/(\d{1,2}):(\d{2})/);
                    if (!m) return 24 * 60; // push to end
                    const h = parseInt(m[1], 10),
                        mm = parseInt(m[2], 10);
                    return h * 60 + mm;
                }

                // Sort by weekday
                const sortWeekdays = (daysArray) => {
                    const dayOrder = [
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                        "Sunday",
                    ];
                    return daysArray.sort(
                        (a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b)
                    );
                };

                // build DOM
                const root = document.getElementById("root");
                root.innerHTML = "";

                const days = sortWeekdays(Object.keys(byDay));
                console.log(days);

                for (const day of days) {
                    const sessions = byDay[day];
                    // compute unique locations for this day (include 'General')
                    const locSet = new Set(
                        sessions.map((s) => normalizeLoc(s.location))
                    );
                    const locations = Array.from(locSet);
                    // sort locations: try to keep Auditorium/B1/B2/B3/Room order if present
                    locations.sort((a, b) => {
                        // custom priorities
                        const order = (loc) => {
                            if (/auditorium/i.test(loc)) return 0;
                            if (/\bB1\b/i.test(loc)) return 1;
                            if (/\bB2\b/i.test(loc)) return 2;
                            if (/\bB3\b/i.test(loc)) return 3;
                            if (/\bRoom\b/i.test(loc)) return 4;
                            if (/Plaza/i.test(loc)) return 5;
                            if (loc === "General") return 10;
                            return 6;
                        };
                        const oa = order(a),
                            ob = order(b);
                        if (oa !== ob) return oa - ob;
                        return a.localeCompare(b);
                    });

                    // group by time slot
                    const byTime = {};
                    for (const s of sessions) {
                        if (!byTime[s.time]) byTime[s.time] = [];
                        byTime[s.time].push(s);
                    }
                    // sort times by start time
                    const times = Object.keys(byTime).sort((a, b) => {
                        return (
                            parseStartMinutes(a) - parseStartMinutes(b) ||
                            a.localeCompare(b)
                        );
                    });

                    // render day container
                    const dayEl = document.createElement("section");
                    dayEl.className = "day";
                    dayEl.innerHTML = `
      <div class="day-header">
        <div class="date">${day}</div>
        <div class="legend">Streams: ${locations.join(" · ")}</div>
      </div>
    `;

                    const table = document.createElement("table");
                    table.className = "streams-table";
                    const thead = document.createElement("thead");
                    const headRow = document.createElement("tr");
                    headRow.innerHTML =
                        `<th class="time-col">Time</th>` +
                        locations.map((l) => `<th>${l}</th>`).join("");
                    thead.appendChild(headRow);
                    table.appendChild(thead);

                    const tbody = document.createElement("tbody");

                    for (const time of times) {
                        const row = document.createElement("tr");
                        const timeCell = document.createElement("td");
                        timeCell.className = "time-col";
                        timeCell.textContent = time;
                        row.appendChild(timeCell);

                        // for each location column, find sessions at this time+location
                        for (const loc of locations) {
                            const cell = document.createElement("td");
                            const items = byTime[time].filter(
                                (s) => normalizeLoc(s.location) === loc
                            );
                            if (items.length === 0) {
                                cell.innerHTML = `<div class="empty">&nbsp;</div>`;
                            } else {
                                // list sessions (stack if multiple)
                                for (const it of items) {
                                    const aStart =
                                        it.url && it.url !== "N/A"
                                            ? `<a href="${it.url}" target="_blank" rel="noopener">`
                                            : "";
                                    const aEnd = aStart ? "</a>" : "";
                                    const authors =
                                        it.authors && it.authors !== "N/A"
                                            ? `<div class="meta">${escapeHtml(
                                                  it.authors
                                              )}</div>`
                                            : "";
                                    const details =
                                        it.details && it.details !== "N/A"
                                            ? `<div class="meta">${escapeHtml(
                                                  it.details
                                              ).slice(0, 300)}${
                                                  it.details.length > 300
                                                      ? "…"
                                                      : ""
                                              }</div>`
                                            : "";
                                    const sessionHtml = `
              <div class="session">
                ${aStart}<div class="title">${escapeHtml(it.title)}</div>${aEnd}
                ${authors}
                ${details}
              </div>
            `;
                                    cell.insertAdjacentHTML(
                                        "beforeend",
                                        sessionHtml
                                    );
                                }
                            }
                            row.appendChild(cell);
                        }

                        tbody.appendChild(row);
                    }

                    table.appendChild(tbody);
                    dayEl.appendChild(table);
                    root.appendChild(dayEl);
                }

                // small utility
                function escapeHtml(str) {
                    if (!str) return "";
                    return String(str).replace(
                        /[&<>"']/g,
                        (s) =>
                            ({
                                "&": "&amp;",
                                "<": "&lt;",
                                ">": "&gt;",
                                '"': "&quot;",
                                "'": "&#39;",
                            }[s])
                    );
                }
            })();
        </script>
    </body>
</html>
