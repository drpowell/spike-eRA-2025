<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Conference Program — Pretty View with Streams</title>
        <style>
            :root {
                --gap: 10px;
                --accent: #0b66c3;
                --muted: #666;
                --highlight-bg: #e6ffed; /* Light green for highlights */
            }
            body {
                font-family: system-ui, -apple-system, Segoe UI, Roboto,
                    Helvetica, Arial;
                color: #111;
                margin: 20px;
                background: #f7f9fc;
            }
            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            h1 {
                margin: 0;
                font-size: 20px;
            }
            .auth-container {
                position: relative;
            }
            .auth-container button {
                padding: 8px 16px;
                font-size: 14px;
                font-weight: 600;
                border-radius: 8px;
                border: 1px solid #ddd;
                background-color: #fff;
                cursor: pointer;
                transition: background-color 0.2s;
            }
            .auth-container button:hover {
                background-color: #f5f5f5;
            }
            .user-info {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            .user-info .email {
                font-size: 14px;
                color: var(--muted);
            }
            .user-info button {
                font-size: 14px;
                color: var(--accent);
                background: none;
                border: none;
                cursor: pointer;
                padding: 0;
            }
            .hidden {
                display: none;
            }
            .day {
                margin: 18px 0;
                padding: 12px;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
            }
            .day-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 12px;
            }
            .day-header .date {
                font-weight: 600;
            }
            .streams-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
            }
            .streams-table thead th {
                position: sticky;
                top: 0;
                background: linear-gradient(180deg, #fff, #fbfdff);
                z-index: 2;
                border-bottom: 1px solid #eee;
                padding: 8px;
                font-weight: 700;
                text-align: left;
            }
            .streams-table td {
                vertical-align: top;
                padding: 8px;
                border-bottom: 1px dashed #eee;
                background: white;
                transition: background-color 0.3s ease; /* Smooth transition for highlighting */
            }
            .streams-table td.clickable {
                cursor: pointer;
            }
            .streams-table td.highlighted {
                background-color: var(--highlight-bg) !important;
            }

            /* When a cell is highlighted, make inner session cards transparent
               so the highlight color fills the whole cell */
            .streams-table td.highlighted .session {
                background: transparent !important;
                border-color: transparent !important;
                box-shadow: none !important;
            }
            /* Make small meta text transparent background too (if present) */
            .streams-table td.highlighted .session .meta {
                background: transparent;
            }

            .time-col {
                width: 12%;
                white-space: nowrap;
                padding-right: 12px;
                font-weight: 600;
                color: var(--muted);
            }
            .session {
                margin-bottom: 8px;
                padding: 8px;
                border-radius: 6px;
                background: linear-gradient(180deg, #fff, #fcffff);
                border: 1px solid #e6f0fb;
            }
            .session .title {
                font-weight: 700;
                color: var(--accent);
                margin-bottom: 4px;
            }
            .session .meta {
                font-size: 12px;
                color: var(--muted);
            }
            .session a {
                color: inherit;
                text-decoration: none;
            }
            .empty {
                color: #bbb;
                font-size: 13px;
                padding: 6px;
            }
            .legend {
                font-size: 13px;
                color: var(--muted);
                margin-top: 8px;
            }
            .filter-container {
                margin: 20px 0;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .toggle-switch {
                display: inline-flex;
                align-items: center;
                cursor: pointer;
            }
            .toggle-switch input {
                display: none;
            }
            .toggle-switch span {
                width: 40px;
                height: 20px;
                border-radius: 10px;
                background: #ddd;
                position: relative;
                transition: background 0.3s;
                margin-right: 8px;
            }
            .toggle-switch span:before {
                content: "";
                position: absolute;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: white;
                top: 2px;
                left: 2px;
                transition: transform 0.3s;
            }
            .toggle-switch input:checked + span {
                background: var(--accent);
            }
            .toggle-switch input:checked + span:before {
                transform: translateX(20px);
            }
            tr.hidden-row {
                display: none;
            }
            @media (max-width: 900px) {
                .streams-table thead th:not(:first-child) {
                    display: none;
                }
                .streams-table td:not(:first-child) {
                    display: none;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>Conference program — concurrent streams</h1>
            <div class="auth-container">
                <button id="login-btn">Login with Google</button>
                <div id="user-info" class="user-info hidden">
                    <span id="user-email" class="email"></span>
                    <button id="logout-btn">Sign Out</button>
                </div>
            </div>
        </div>

        <div class="filter-container">
            <label class="toggle-switch">
                <input type="checkbox" id="highlight-toggle" />
                <span></span>
                Show only highlighted sessions
            </label>
        </div>
        <div id="root">Loading…</div>

        <script type="module">
            // Firebase SDK Imports
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import {
                getAuth,
                GoogleAuthProvider,
                signInWithPopup,
                onAuthStateChanged,
                signOut,
            } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import {
                getFirestore,
                doc,
                setDoc,
                onSnapshot,
            } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            // --- 1. FIREBASE CONFIG & INITIALIZATION ---

            // IMPORTANT: Replace with your Firebase project's configuration
            const firebaseConfig = {
                apiKey: "AIzaSyD_HhVzoRqw7dPcy5VULFou9OnOQxbfzs8",
                authDomain: "era-2025.firebaseapp.com",
                projectId: "era-2025",
                storageBucket: "era-2025.firebasestorage.app",
                messagingSenderId: "378716267717",
                appId: "1:378716267717:web:d1902c4e9b475d98a23cac",
                measurementId: "G-LWK2XKQ8ZH",
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = firebaseConfig.projectId || "conference-app";

            // --- 2. STATE MANAGEMENT ---

            let currentUser = null;
            let userHighlights = new Set();
            let unsubscribeFromHighlights = null;

            // --- 3. DOM ELEMENTS ---

            const loginBtn = document.getElementById("login-btn");
            const logoutBtn = document.getElementById("logout-btn");
            const userInfoEl = document.getElementById("user-info");
            const userEmailEl = document.getElementById("user-email");
            const root = document.getElementById("root");
            const highlightToggle = document.getElementById("highlight-toggle");

            // --- 4. AUTHENTICATION ---

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    loginBtn.classList.add("hidden");
                    userInfoEl.classList.remove("hidden");
                    userEmailEl.textContent = user.displayName || user.email;
                    listenForHighlights(user.uid);
                    document.body.classList.add("logged-in");
                } else {
                    // User is signed out
                    currentUser = null;
                    loginBtn.classList.remove("hidden");
                    userInfoEl.classList.add("hidden");
                    userEmailEl.textContent = "";
                    if (unsubscribeFromHighlights) {
                        unsubscribeFromHighlights();
                    }
                    userHighlights.clear();
                    updateVisibleHighlights();
                    document.body.classList.remove("logged-in");
                }
            });

            loginBtn.addEventListener("click", async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Sign-in error", error);
                }
            });

            logoutBtn.addEventListener("click", async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Sign-out error", error);
                }
            });

            // --- 5. FIRESTORE & HIGHLIGHT LOGIC ---

            function listenForHighlights(uid) {
                const docPath = `/artifacts/${appId}/users/${uid}/highlights/sessions`;
                const highlightsDocRef = doc(db, docPath);

                unsubscribeFromHighlights = onSnapshot(
                    highlightsDocRef,
                    (docSnap) => {
                        userHighlights.clear();
                        if (docSnap.exists() && docSnap.data().sessionIds) {
                            docSnap
                                .data()
                                .sessionIds.forEach((id) =>
                                    userHighlights.add(id)
                                );
                        }
                        updateVisibleHighlights();
                    }
                );
            }

            async function handleCellClick(event) {
                if (!currentUser) return;

                const cell = event.currentTarget;
                const cellId = cell.dataset.cellId;
                if (!cellId) return;

                if (userHighlights.has(cellId)) {
                    userHighlights.delete(cellId);
                } else {
                    userHighlights.add(cellId);
                }

                // Update UI immediately for responsiveness
                cell.classList.toggle("highlighted");

                // Save to Firestore
                const docPath = `/artifacts/${appId}/users/${currentUser.uid}/highlights/sessions`;
                const highlightsDocRef = doc(db, docPath);
                await setDoc(highlightsDocRef, {
                    sessionIds: Array.from(userHighlights),
                });
            }

            function toggleHighlightedSessions(showOnlyHighlighted) {
                const rows = document.querySelectorAll(
                    ".streams-table tbody tr"
                );
                rows.forEach((row) => {
                    if (showOnlyHighlighted) {
                        const hasHighlight = row.querySelector(".highlighted");
                        if (!hasHighlight) {
                            row.classList.add("hidden-row");
                        } else {
                            row.classList.remove("hidden-row");
                        }
                    } else {
                        row.classList.remove("hidden-row");
                    }
                });
            }

            function updateVisibleHighlights() {
                const allCells = document.querySelectorAll("[data-cell-id]");
                allCells.forEach((cell) => {
                    const cellId = cell.dataset.cellId;
                    if (userHighlights.has(cellId)) {
                        cell.classList.add("highlighted");
                    } else {
                        cell.classList.remove("highlighted");
                    }
                });

                // Maintain filter state if toggle is checked
                if (highlightToggle.checked) {
                    toggleHighlightedSessions(true);
                }
            }

            // --- 6. RENDER CONFERENCE PROGRAM ---

            async function renderProgram() {
                try {
                    const res = await fetch("./conference_program.json");
                    if (!res.ok) throw new Error(res.statusText);
                    const data = await res.json();

                    root.innerHTML = ""; // Clear "Loading..." message

                    const byDay = {};
                    for (const item of data) {
                        const day = item.day || "Unknown";
                        const time = (item.time || "").trim() || "TBA";
                        const loc =
                            (item.location || "N/A").trim() === "N/A"
                                ? "General"
                                : item.location.trim();
                        if (!byDay[day]) byDay[day] = [];
                        byDay[day].push({ ...item, time, location: loc });
                    }

                    const sortWeekdays = (arr) => {
                        const order = [
                            "Monday",
                            "Tuesday",
                            "Wednesday",
                            "Thursday",
                            "Friday",
                            "Saturday",
                            "Sunday",
                        ];
                        return arr.sort(
                            (a, b) => order.indexOf(a) - order.indexOf(b)
                        );
                    };

                    const days = sortWeekdays(Object.keys(byDay));

                    for (const day of days) {
                        // ... [rest of the table rendering logic remains the same]
                        const sessions = byDay[day];
                        const locSet = new Set(sessions.map((s) => s.location));
                        const locations = Array.from(locSet).sort((a, b) => {
                            const order = (loc) => {
                                if (/auditorium/i.test(loc)) return 0;
                                if (/\bB1\b/i.test(loc)) return 1;
                                if (/\bB2\b/i.test(loc)) return 2;
                                if (/\bB3\b/i.test(loc)) return 3;
                                if (/\bRoom\b/i.test(loc)) return 4;
                                if (/Plaza/i.test(loc)) return 5;
                                if (loc === "General") return 10;
                                return 6;
                            };
                            return order(a) - order(b) || a.localeCompare(b);
                        });

                        const byTime = {};
                        for (const s of sessions) {
                            if (!byTime[s.time]) byTime[s.time] = [];
                            byTime[s.time].push(s);
                        }

                        const parseMins = (t) => {
                            const m = t.match(/(\d{1,2}):(\d{2})/);
                            return m
                                ? parseInt(m[1], 10) * 60 + parseInt(m[2], 10)
                                : 24 * 60;
                        };
                        const times = Object.keys(byTime).sort(
                            (a, b) =>
                                parseMins(a) - parseMins(b) ||
                                a.localeCompare(b)
                        );

                        const dayEl = document.createElement("section");
                        dayEl.className = "day";
                        dayEl.innerHTML = `<div class="day-header"><div class="date">${day}</div><div class="legend">Streams: ${locations.join(
                            " · "
                        )}</div></div>`;

                        const table = document.createElement("table");
                        table.className = "streams-table";
                        table.innerHTML = `<thead><tr><th class="time-col">Time</th>${locations
                            .map((l) => `<th>${l}</th>`)
                            .join("")}</tr></thead>`;

                        const tbody = document.createElement("tbody");
                        for (const time of times) {
                            const row = document.createElement("tr");
                            row.innerHTML = `<td class="time-col">${time}</td>`;

                            for (const loc of locations) {
                                const cell = document.createElement("td");
                                const items = byTime[time].filter(
                                    (s) => s.location === loc
                                );

                                if (items.length === 0) {
                                    // Do NOT make empty cells selectable/clickable
                                    cell.innerHTML = `<div class="empty">&nbsp;</div>`;
                                } else {
                                    // Only non-empty cells get an id, clickable class and listener
                                    const cellId = `${day}-${time}-${loc}`
                                        .replace(/[\s:/]/g, "-")
                                        .toLowerCase();
                                    cell.dataset.cellId = cellId;
                                    cell.classList.add("clickable");
                                    cell.addEventListener(
                                        "click",
                                        handleCellClick
                                    );

                                    cell.innerHTML = items
                                        .map((it) => {
                                            const aStart =
                                                it.url && it.url !== "N/A"
                                                    ? `<a href="${it.url}" target="_blank" rel="noopener">`
                                                    : "";
                                            const aEnd = aStart ? "</a>" : "";
                                            const authors =
                                                it.authors &&
                                                it.authors !== "N/A"
                                                    ? `<div class="meta">${escapeHtml(
                                                          it.authors
                                                      )}</div>`
                                                    : "";
                                            const details =
                                                it.details &&
                                                it.details !== "N/A"
                                                    ? `<div class="meta">${escapeHtml(
                                                          it.details
                                                      ).slice(0, 300)}${
                                                          it.details.length >
                                                          300
                                                              ? "…"
                                                              : ""
                                                      }</div>`
                                                    : "";
                                            return `<div class="session">${aStart}<div class="title">${escapeHtml(
                                                it.title
                                            )}</div>${aEnd}${authors}${details}</div>`;
                                        })
                                        .join("");
                                }
                                row.appendChild(cell);
                            }
                            tbody.appendChild(row);
                        }
                        table.appendChild(tbody);
                        dayEl.appendChild(table);
                        root.appendChild(dayEl);
                    }
                    updateVisibleHighlights(); // Apply highlights after table is built
                } catch (e) {
                    root.innerHTML = `<p style="color:#900">Failed to load conference program. (${e.message})</p>`;
                }
            }

            function escapeHtml(str) {
                if (!str) return "";
                return String(str).replace(
                    /[&<>"']/g,
                    (s) =>
                        ({
                            "&": "&amp;",
                            "<": "&lt;",
                            ">": "&gt;",
                            '"': "&quot;",
                            "'": "&#39;",
                        }[s])
                );
            }

            highlightToggle.addEventListener("change", (e) => {
                toggleHighlightedSessions(e.target.checked);
            });

            renderProgram();
        </script>
    </body>
</html>
